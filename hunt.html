<!DOCTYPE html>
<html>
<body>

<p>Click the button to begin.[4]</p>

<button onclick="tryInit()">Start</button>

<p id="output"></p>
<p id="output2"></p>

<script>
var x = document.getElementById("output");
var y = document.getElementById("output2");
var compass = 0;
var lat = 0;
var lon = 0;
var arrows = ["↑","↗","→","↘","↓","↙","←","↖"];

isIOS = (
  navigator.userAgent.match(/(iPod|iPhone|iPad)/) &&
  navigator.userAgent.match(/AppleWebKit/)
);

function tryInit() {
if (isIOS) {
    DeviceOrientationEvent.requestPermission()
      .then((response) => {
        if (response === "granted") {
          getLocation();
        } else {
          alert("has to be allowed!");
        }
      })
      .catch(() => alert("not supported"));
  } else {
    getLocation();
  }
}

function getLocation() {
  if (navigator.geolocation) {
    x.innerHTML = "Loading...";
    navigator.geolocation.watchPosition(posHandler);
    window.addEventListener(isIOS ? 'deviceorientation' : 'deviceorientationabsolute', oriHandler, true);
  } else { 
    x.innerHTML = "Geolocation is not supported by this browser.";
  }
}

function posHandler(position) {
  msg = "Latitude: " + position.coords.latitude + 
  "\n<br>Longitude: " + position.coords.longitude +
  "\n<br>Heading: " + position.coords.heading;
  console.log("POS "+msg);
  lat = position.coords.latitude;
  lon = position.coords.longitude;
//x.innerHTML = msg;
  updateDir();
}

function oriHandler(event) {
  compass = (isIOS ? event.webkitCompassHeading : Math.abs(event.alpha - 360));
  if(compass < 0) compass += 360;
  compass = compass % 360;
  
  msg = "[" + event.alpha + ' : ' + event.beta + ' : ' + event.gamma + "]";
  msg += "\n<br>Absolute? " + event.absolute;
  msg += "\n<br>Heading " + compass;
  console.log("ORI "+msg);
//y.innerHTML = msg;

  updateDir();
}

function updateDir() {
//      compassCircle.style.transform = `translate(-50%, -50%) rotate(${-compass}deg)`;
	x.innerHTML = arrows[compass/45];   
}


</script>

</body>
</html>

